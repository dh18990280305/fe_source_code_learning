
# 执行上下文 / 调用栈 / 作用域链

### 一. 执行上下文

定义：执行上下文是Javascript代码被解析和执行时所在的环境，里面存储了代码执行所需要的信息；

1. **执行上下文的类型**
- 全局执行上下文 - global EC
  * 代码开始执行前首先进入的环境。
  * 一个程序只有**一个**全局执行上下文。
  * 创建一个全局对象(浏览器中时Window，Node中时global)，将this指向这个全局对象。

- 函数执行上下文 - Function EC
  * 每当一个函数调用时都会创建一个新的FEC, 不限制个数。

- Eval执行上下文
  * 运行在 eval 函数内部的代码（开发中禁止使用，了解）。

2. **执行上下文的生命周期（重点：创建与销毁）**
执行上下文的生命周期分为两个阶段：创建阶段 和 执行阶段。
 - 创建阶段
 在代码真正执行之前，JS 引擎会先扫描一遍，做三件大事：
   1. 确定 this 的指向：
      * 全局环境：this -> window。
      * 函数环境：取决于函数如何被调用（普通调用、对象调用、new 调用、apply/call/bind）。

   2. 词法环境(LE)：
      * 创建环境记录：存储变量和函数声明。
      * 创建外部环境引用：记录当前环境的 “父级” 环境（作用域链的关键）。

   3. 变量环境(VE)：
      * 同样包含一个环境记录和外部引用。
      * 区别： 在 ES6 中，词法环境(ES6新增，无变量提升)用于存储 let 和 const 声明的变量（处于 TDZ 暂存死区，不会变量“初始化”，提前访问报错），而变量环境(VE)专门用于存储 var 声明 的变量（会被提升，初始化为 undefined）。
 - 执行阶段。
   * 变量赋值。
   * 函数执行。 
   * 代码一行行运行。
 - 销毁阶段
   * 函数执行完毕后，它的执行上下文会被弹出栈，等待垃圾回收机制回收。
   * 注意：闭包会阻止这个销毁过程。

3. **GO / AO / VO / VE /LE**
   - GO：全局对象，属性AO对应GO，也是浏览器中的Window。
   - AO：函数执行上下文中对应的对象，VO对应AO。
   - VO: es5中的概念，全局环境下VO对应GO，函数调用时的VO对应AO;
   - VE: 变量环境，es6之后加入的概念，与es5中VO基本一致，专门存储var和函数声明，有变量提升。
   - LE: 词法环境，es6新增，专门存储let和const变量声明；

### 二. 调用栈

定义：调用栈是一个后进先出 (LIFO) 的数据结构，用于存储代码执行过程中所有处于运行状态的执行上下文。

1. **工作原理**
   - 当js开始执行前，会先创建全局执行上下文，并压入栈底。
   - 当遇到函数调用时，创建函数执行上下文，压入栈顶（后劲先出）。
   - js引擎从栈顶开始执行代码。
   - 当执行完一个函数后，执行上下文后弹出，继续执行栈顶下一个执行上下文。
2. **代码示例**
   ```js
    function foo() {
      console.log('foo');
      bar();
    }

    function bar() {
      console.log('bar');
    }

    foo();
   ```
   调用栈变化过程：
   1.global ec入栈。
   2.执行foo，foo ec入栈。
   3.执行console.log('foo')，内置函数入栈。
   4.console.log('foo')执行完毕出栈。
   5.执行bar函数，bar ec入栈。
   6.执行console.log('bar')，执行完毕出栈。
   7.bar函数执行完毕，bar ec出栈。
   8.foo函数执行完毕，foo ec出栈。
   9.程序结束，global ec出栈。

### 三. 作用域与作用域链

1. **作用域**
   **定义**： 变量和函数的可访问范围。
   - 词法作用域：js采用词法作用域，意味着变量和函数可访问范围是由**代码编写定义的位置**决定的。

2. **作用域链**
   **定义**：当查找一个变量时，js引擎会现在当前执行上下文中进行查找，如果找不到，就会去**父级**执行上下文查找，一致找到全局执行上下文，这种**链式查找关系**就是作用域链[每个执行上下文都有一个 [[Environment]] (外部环境引用) 属性，它指向了外层的执行上下文]。
   - 作用域链 = 当前执行上下文 + 所有父级执行上下文的变量对象。

### 四. 图形化理解

为了直观理解整个执行流程，绘制了对应的流程图：

![JS 执行上下文与调用栈流程图](./execution_stack_flowchart.svg)