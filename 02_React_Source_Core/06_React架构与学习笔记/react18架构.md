# React架构

## 一. Stack Reconciler 与 Fiber Reconciler 核心差异
1.Stack Reconciler（旧版协调器，React 16 前）
- 核心特性：基于递归同步执行的协调机制，以 “调用栈” 驱动组件的挂载、更新、卸载，从根组件到子组件一次性完成整棵虚拟 DOM 树的比对与更新。
- 核心问题：递归过程不可中断、不可暂停，若组件树较深 / 复杂，会占用主线程过长时间，阻塞浏览器的重绘（repaint）、重排（reflow）、用户交互等关键操作，导致页面出现卡顿、掉帧，交互体验差。
- 执行模式：同步渲染，一旦开始就必须执行到底，无优先级区分。

2.Fiber Reconciler（新版协调器，React 16+ 核心，React 18 持续优化）
- 核心特性：基于可中断、可暂停、可恢复的链表结构协调机制，将虚拟 DOM 树重构为Fiber 链表（每个 Fiber 节点对应一个组件，包含组件信息、更新状态、依赖关系等），把整棵树的比对拆分为单个 Fiber 节点的小任务单元。
- 核心优势：借助浏览器requestIdleCallback（空闲调度）与 React 自研调度器，在主线程空闲时执行 Fiber 比对任务，若有更高优先级操作（如用户点击、动画），则暂停当前任务，优先执行高优先级操作，操作完成后再恢复之前的比对，彻底解决主线程阻塞问题，提升页面流畅度。
- 执行模式：支持异步渲染、优先级调度（如用户交互 > 数据请求 > 普通更新），为 React 18 并发特性奠定底层基础。

| 对比维度 | 优点 | 缺点 |
| ----------- | ----------- | ----------- |
| 数据结构 | 虚拟dom(递归遍历) | Fiber双向链表(迭代遍历) |
| 执行特性   | 同步、不可中断、不可暂停 | 异步、可中断、可暂停、可恢复 |
| 调度方式 | 无调度，一次性执行 | 结合调度器，空闲时执行、优先级驱动 |
| 主线程占用 | 长时间占用，易阻塞 | 碎片化占用，不阻塞关键操作 |
| 底层支撑 | 仅支持同步渲染 | 支持并发渲染（React 18 核心能力）|

## 二、React 18 三大核心架构模块（从下到上分层设计）
React 18 架构基于 Fiber 核心 做了全链路升级，三大模块层层依赖、分工明确，支撑起 “并发渲染、自动批处理、新根节点 API” 等核心能力，整体为分层解耦架构，各模块独立演进且可灵活组合。

模块 1：Fiber 核心层（底层基石，协调器核心）
- *核心定位*：React 架构的 “骨架”，负责虚拟 DOM 与真实 DOM 的桥梁，任务拆分、优先级管理、中断 / 恢复逻辑，在任务拆分、优先级管理、中断&恢复逻辑扮演执行者身份，负责具体实现，如何做。
- *核心组成*：Fiber 节点（单向链表 + 双向链表，记录组件状态、更新队列、依赖关系）、Fiber 树（分为「当前树（current）」与「工作树（workInProgress）」，双树切换实现无感知更新）、协调流程（分为「渲染阶段（Render Phase）」与「提交阶段（Commit Phase）」）。
- *核心能力*：
  - 渲染阶段（可中断）：完成 Fiber 节点的创建、比对（Reconciliation）、更新队列处理，生成工作树，此阶段操作不会修改真实 DOM，可随时暂停 / 放弃；
  - 提交阶段（不可中断）：将渲染阶段的结果一次性同步到真实 DOM，执行组件生命周期（如 componentDidMount）、副作用（如 useEffect），此阶段保证操作原子性，避免页面错乱。
- *React 18 升级点*：优化 Fiber 节点的更新队列设计，支持并发更新的优先级排序，为多任务并发执行提供底层支持。

模块 2：调度器层（Scheduler，任务调度中心）
- *核心定位*：Fiber 核心层的 “大脑”，负责全局任务的调度、优先级排序、空闲时机检测，决定哪个 Fiber 任务何时执行。
- *核心设计*：独立于 React 核心的调度模块（可单独复用），基于时间片调度和优先级队列实现，将任务分为不同优先级（如「即时优先级（用户交互）」>「高优先级（动画）」>「普通优先级（数据更新）」>「低优先级（懒加载）」）。
- *核心能力*
  1. 空闲检测：通过 requestIdleCallback 兼容 + 自研时间片算法，检测浏览器主线程的空闲时间；
  2. 任务调度：将 Fiber 拆分后的小任务，按优先级放入对应队列，在浏览器空闲时取出执行，若超出时间片则暂停任务，等待下一次空闲；
  3. 任务中断与恢复：当高优先级任务进入队列时，暂停当前低优先级任务，优先执行高优先级任务，执行完成后恢复低优先级任务。
- *React18升级点*：强化并发调度能力，支持「非阻塞调度」，为 useTransition、useDeferredValue 等并发 API 提供调度支持，保证高优先级交互的响应速度。

模块 3：渲染器层（Renderer，平台适配层）

- *核心定位*：React 架构的 “出口”，负责将 Fiber 核心层的处理结果渲染到具体平台，实现 React 的跨平台能力，核心是 “协调结果的平台化落地”。
- *核心组成*：不同平台的专属渲染器，如「React DOM（浏览器端）」、「React Native（移动端）」、「React SSR（服务端渲染）」、「React Test Renderer（测试环境）」，所有渲染器均基于统一的 Fiber 核心协议开发。
- *核心能力*：
  1. 平台适配：将 Fiber 树的更新指令（如创建、更新、删除节点）转换为对应平台的原生操作（如浏览器端的 createElement、setAttribute，RN 端的原生组件创建）；
  2. 提交阶段执行：在 Fiber 核心层的提交阶段，执行平台相关的副作用（如浏览器端的 DOM 操作、事件绑定）；
  3. 跨平台统一：保证不同平台下，React 组件的生命周期、Hook 用法、更新逻辑一致，仅底层渲染实现不同。
- React 18 升级点
  1. 浏览器渲染器（React DOM）支持并发渲染（Concurrent Rendering）、自动批处理（Automatic Batching）、新根节点 API（createRoot 替代 ReactDOM.render）；
  2. 强化 SSR 渲染器的流式渲染（Streaming SSR） 和服务端组件（RSC） 支持，提升服务端渲染性能与首屏加载速度。

三、React 18 完整架构图
架构分层（从下到上，依赖关系：上层依赖下层，下层不感知上层）
```plaintext
┌─────────────────────────────────────────────────────────────────┐
│ 应用层：React 组件（类组件/函数组件）、Hook、业务逻辑            │
│ （基于 React API 开发，无感知底层架构）                          │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│ 核心 API 层：createRoot、useState/useEffect、useTransition、      │
│ useDeferredValue、startTransition（React 18 新API，封装底层能力）│
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│ 三大核心架构模块                                                │
│ ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│ │  渲染器层       │  │  调度器层       │  │  Fiber 核心层   │  │
│ │ （Renderer）    │  │ （Scheduler）   │  │ （Fiber Core）  │  │
│ │ - React DOM     │◄─┼─► 优先级调度    │◄─┼─► Fiber 链表/树 │  │
│ │ - React Native  │  │ - 空闲检测      │  │ - 渲染/提交阶段 │  │
│ │ - React SSR     │  │ - 任务中断/恢复 │  │ - 虚拟DOM比对   │  │
│ │ - 其他平台渲染器│  │ - 时间片调度    │  │ - 更新队列管理   │  │
│ └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│ （调度器为 Fiber 分配执行时机，渲染器落地 Fiber 处理结果）        │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│ 底层平台：浏览器/Node.js/移动端（iOS/Android）/测试环境          │
│ （提供原生 API 支持，如 DOM API、原生组件、Node 服务端能力）      │
└─────────────────────────────────────────────────────────────────┘
```
### 核心流转逻辑（一次组件更新的完整链路）
应用层组件触发更新 → 核心 API 层封装更新请求并标记优先级 → 调度器层接收请求，按优先级加入任务队列 → 调度器检测浏览器空闲，取出任务交给 Fiber 核心层 → Fiber 核心层执行可中断的渲染阶段，生成工作树 → Fiber 核心层执行不可中断的提交阶段，通知渲染器层 → 渲染器层将更新结果落地到具体平台 → 完成组件更新，页面刷新

四、React 架构演进核心

1. 整体演进脉络：从 “同步阻塞” 到 “异步并发”，从 “单一渲染” 到 “跨平台多端统一”

React 15 及以前（Stack Reconciler） → React 16（Fiber Reconciler 落地，支持异步渲染） → React 17（架构过渡，无核心架构变更，兼容升级） → React 18（基于 Fiber 完善并发架构，三大模块升级，支持并发渲染/自动批处理/新根API）

2. 架构演进核心目标
 - 提升用户体验：解决主线程阻塞问题，保证用户交互、动画等高频操作的流畅性；
 - 增强架构扩展性：分层解耦（Fiber / 调度器 / 渲染器分离），支持跨平台扩展、新特性快速迭代；
 - 强化并发能力：从 “单任务同步执行” 到 “多任务并发调度”，适配复杂前端场景（如大数据渲染、高频交互、服务端渲染）；
 - 保证向下兼容：架构升级的同时，兼容旧版组件、API，降低迁移成本。

3. React 18 架构的核心价值
- *性能体验提升*：并发渲染让页面在复杂更新时仍保持流畅，自动批处理减少不必要的重渲染，提升更新效率；
- *开发体验优化*：新根 API（createRoot）简化配置，useTransition/useDeferredValue 等并发 API 让开发者可轻松实现 “非阻塞更新”，无需关注底层调度细节；
- *生态兼容升级*：分层架构让第三方库（如 UI 组件库、状态管理库）可基于统一的 Fiber 协议适配，提升生态一致性；
- *服务端能力强化*：流式 SSR、服务端组件（RSC）支持，让 React 从 “前端渲染框架” 升级为 “全栈渲染框架”，提升首屏加载速度和服务端渲染灵活性。

4. 关键演进节点总结
- React 16：架构重构，推出 Fiber Reconciler 替代 Stack Reconciler，解决核心的 “同步阻塞” 问题，为并发渲染打下基础；
- React 18：架构完善，基于 Fiber 核心升级三大架构模块，实现并发渲染的工业化落地，让 React 正式进入 “并发时代”，是 React 自 Fiber 以来最核心的架构升级。