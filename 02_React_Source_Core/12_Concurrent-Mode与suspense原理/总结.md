### ä¸€ã€æ ¸å¿ƒçŸ¥è¯†ç‚¹æ¢³ç†
1. å¹¶å‘æ›´æ–°ï¼ˆConcurrent Updatesï¼‰
- *æ ¸å¿ƒæ¦‚å¿µ*ï¼šä¼ ç»Ÿ React æ›´æ–°æ˜¯ â€œåŒæ­¥ä¸”ä¸å¯ä¸­æ–­â€ çš„ï¼Œä¸€æ—¦å¼€å§‹æ¸²æŸ“å°±ä¼šå ç”¨ä¸»çº¿ç¨‹ç›´åˆ°å®Œæˆï¼Œå®¹æ˜“å¯¼è‡´é¡µé¢å¡é¡¿ï¼›è€Œå¹¶å‘æ›´æ–°å…è®¸ React ä¸­æ–­ã€æš‚åœã€æ¢å¤æˆ–æ”¾å¼ƒæ­£åœ¨è¿›è¡Œçš„æ¸²æŸ“ï¼Œä¼˜å…ˆå¤„ç†é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆæ¯”å¦‚ç”¨æˆ·è¾“å…¥ï¼‰ï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆæ¯”å¦‚åˆ—è¡¨æ¸²æŸ“ï¼‰å¯ä»¥è¢«å»¶åï¼Œè¿™æ˜¯ Concurrent Mode çš„æ ¸å¿ƒã€‚
- *å…³é”®é€»è¾‘*ï¼šReact é€šè¿‡ â€œä¼˜å…ˆçº§è°ƒåº¦â€ å®ç°å¹¶å‘ï¼Œç»™ä¸åŒçš„æ›´æ–°ä»»åŠ¡åˆ†é…ä¸åŒçš„ä¼˜å…ˆçº§ï¼ˆæ¯”å¦‚ ImmediatePriorityã€UserBlockingPriorityã€NormalPriority ç­‰ï¼‰ï¼Œè°ƒåº¦å™¨ï¼ˆSchedulerï¼‰ä¼šæ ¹æ®ä¼˜å…ˆçº§å†³å®šå…ˆæ‰§è¡Œå“ªä¸ªä»»åŠ¡ï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡ä¼šè¢«é«˜ä¼˜å…ˆçº§ä»»åŠ¡ â€œæ‰“æ–­â€ï¼Œç­‰ä¸»çº¿ç¨‹ç©ºé—²åå†æ¢å¤ã€‚

2. Suspense å·¥ä½œåŸç†
- *æ ¸å¿ƒæ¦‚å¿µ*ï¼šSuspense å…è®¸ç»„ä»¶ â€œæš‚åœæ¸²æŸ“â€ï¼Œç›´åˆ°æŸä¸ªå¼‚æ­¥æ“ä½œï¼ˆæ¯”å¦‚æ•°æ®è¯·æ±‚ã€ä»£ç åŠ è½½ï¼‰å®Œæˆï¼ŒæœŸé—´æ˜¾ç¤º fallback å ä½å†…å®¹ï¼Œå¼‚æ­¥æ“ä½œå®Œæˆåå†æ¸²æŸ“å®é™…å†…å®¹ã€‚
- *å·¥ä½œæµç¨‹*ï¼š
1. ç»„ä»¶æ¸²æŸ“æ—¶å¦‚æœè¯»å–äº†ä¸€ä¸ª â€œæœªå°±ç»ªâ€ çš„å¼‚æ­¥èµ„æºï¼ˆæ¯”å¦‚å°è£…äº† Promise çš„å¯¹è±¡ï¼‰ï¼Œä¼šæŠ›å‡ºè¿™ä¸ª Promiseï¼›
2. React æ•è·åˆ°è¿™ä¸ª Promise åï¼Œä¼šæš‚åœå½“å‰ç»„ä»¶çš„æ¸²æŸ“ï¼Œæ˜¾ç¤º Suspense å®šä¹‰çš„ fallbackï¼›
3. å½“ Promise æˆåŠŸ resolve åï¼ŒReact ä¼šé‡æ–°æ¸²æŸ“è¯¥ç»„ä»¶ï¼Œæ­¤æ—¶å¼‚æ­¥èµ„æºå·²å°±ç»ªï¼Œæ¸²æŸ“å®é™…å†…å®¹ï¼›
å¦‚æœ Promise rejectï¼Œä¼šè§¦å‘é”™è¯¯è¾¹ç•Œï¼ˆError Boundaryï¼‰ã€‚

3. useDeferredValue / useTransition
- useTransitionï¼šæ ‡è®°æŸä¸ªæ›´æ–°ä¸º â€œä½ä¼˜å…ˆçº§è¿‡æ¸¡æ›´æ–°â€ï¼Œä¸ä¼šé˜»å¡ç”¨æˆ·äº¤äº’ï¼Œè¿”å› [isPending, startTransition]ï¼ŒstartTransition åŒ…è£¹çš„æ›´æ–°ä¼šè¢«å»¶åæ‰§è¡Œï¼ŒisPending æ ‡è¯†æ›´æ–°æ˜¯å¦è¿˜åœ¨è¿›è¡Œã€‚
- useDeferredValueï¼šå¯¹ä¸€ä¸ªå€¼åˆ›å»º â€œå»¶è¿Ÿç‰ˆæœ¬â€ï¼Œè¯¥å€¼çš„æ›´æ–°ä¼šè¢«å»¶åï¼Œä¼˜å…ˆä¿è¯å½“å‰ç•Œé¢çš„å“åº”æ€§ï¼Œå¸¸ç”¨äºä¼˜åŒ–åˆ—è¡¨è¿‡æ»¤ç­‰åœºæ™¯ã€‚

### äºŒã€æ¨¡æ‹Ÿ Suspense åŸºç¡€åŠŸèƒ½å®ç°
ä¸‹é¢æ˜¯ä¸€ä¸ªæç®€ç‰ˆçš„ Suspense æ¨¡æ‹Ÿå®ç°ï¼Œæ ¸å¿ƒè¿˜åŸ â€œæš‚åœæ¸²æŸ“ - ç­‰å¾…å¼‚æ­¥ - æ¸²æŸ“å†…å®¹â€ çš„æ ¸å¿ƒé€»è¾‘
```js
// æ¨¡æ‹Ÿ React çš„ Suspense æ ¸å¿ƒé€»è¾‘
class SuspenseSimulator {
  constructor() {
    // å­˜å‚¨å¾…è§£æçš„ Promise å’Œå¯¹åº”çš„é‡è¯•æ¸²æŸ“å‡½æ•°
    this.pendingPromises = new Map();
    // æ ¹å®¹å™¨
    this.root = null;
  }

  // æŒ‚è½½æ ¹ç»„ä»¶
  render(element, container) {
    this.root = container;
    this._renderElement(element);
  }

  // æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ï¼šæ•è·å¼‚æ­¥èµ„æºçš„ Promiseï¼Œæ˜¾ç¤º fallbackï¼Œç­‰å¾…åé‡è¯•
  _renderElement(element) {
    try {
      // æ¸²æŸ“ç»„ä»¶å†…å®¹ï¼ˆå¦‚æœç»„ä»¶è¯»å–æœªå°±ç»ªçš„å¼‚æ­¥èµ„æºï¼Œä¼šæŠ›å‡º Promiseï¼‰
      const content = element.type({ fallback: element.props.fallback });
      this.root.innerHTML = '';
      this.root.appendChild(content);
    } catch (e) {
        console.log('catch', e)
      // æ•è·åˆ° Promiseï¼Œè¿›å…¥ Suspense ç­‰å¾…é€»è¾‘
      if (e instanceof Promise) {
        const promise = e;
        // æ˜¾ç¤º fallback å†…å®¹
        this.root.innerHTML = '';
        this.root.appendChild(element.props.fallback);

        // é¿å…é‡å¤ç›‘å¬åŒä¸€ä¸ª Promise
        if (!this.pendingPromises.has(promise)) {
          this.pendingPromises.set(promise, () => {
            this._renderElement(element);
            this.pendingPromises.delete(promise);
          });

          // ç­‰å¾… Promise å®Œæˆåï¼Œé‡æ–°æ¸²æŸ“
          promise.then(() => {
            const retryRender = this.pendingPromises.get(promise);
            retryRender && retryRender();
          }).catch(err => {
            console.error('Suspense å¼‚æ­¥èµ„æºåŠ è½½å¤±è´¥:', err);
            this.root.innerHTML = '<div>åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            this.pendingPromises.delete(promise);
          });
        }
      } else {
        // é Promise å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º
        throw e;
      }
    }
  }
}

// ---------------------- æµ‹è¯•ç”¨ä¾‹ ----------------------
// 1. æ¨¡æ‹Ÿå¼‚æ­¥èµ„æºï¼ˆæ¯”å¦‚è¿œç¨‹æ•°æ®è¯·æ±‚ï¼‰
function fetchData() {
  // æ¨¡æ‹Ÿ 2 ç§’åè¿”å›æ•°æ®
  const promise = new Promise(resolve => {
    setTimeout(() => {
      resolve({ name: 'React Suspense æ¨¡æ‹Ÿå®ç°', author: 'å­¦ä¹ ç¬”è®°' });
    }, 2000);
  });

  // å°è£…æˆ Suspense å¯è¯†åˆ«çš„â€œæœªå°±ç»ªèµ„æºâ€ï¼šè¯»å–æ—¶æŠ›å‡º Promise
  let status = 'pending';
  let result = null;
  return {
    read() {
      if (status === 'pending') {
        throw promise; // æŠ›å‡º Promiseï¼Œè§¦å‘ Suspense
      } else if (status === 'error') {
        throw new Error('æ•°æ®åŠ è½½å¤±è´¥');
      } else {
        return result;
      }
    },
    // è§¦å‘æ•°æ®åŠ è½½
    load() {
      promise.then(data => {
        status = 'success';
        result = data;
      }).catch(() => {
        status = 'error';
      });
    }
  };
}

const dataResource = fetchData();

// 2. æ¨¡æ‹Ÿä¾èµ–å¼‚æ­¥èµ„æºçš„ç»„ä»¶
const DataComponent = ({ fallback }) => {
    dataResource.load(); // è§¦å‘æ•°æ®åŠ è½½
    const data = dataResource.read(); // è¯»å–æ•°æ®ï¼Œæœªå°±ç»ªæ—¶æŠ›å‡º Promise

    // æ¸²æŸ“å®é™…å†…å®¹
    const div = document.createElement('div');
    div.style.padding = '20px';
    div.innerHTML = `
        <h3>${data.name}</h3>
        <p>${data.author}</p>
        <p>åŠ è½½å®Œæˆæ—¶é—´ï¼š${new Date().toLocaleTimeString()}</p>
    `;
    return div;
};

// 3. æ¨¡æ‹Ÿ Suspense ç»„ä»¶

const Suspense = ({ fallback, children }) => {
  // è¿™é‡Œç®€åŒ–å¤„ç†ï¼šchildren æ˜¯éœ€è¦å¼‚æ­¥åŠ è½½çš„ç»„ä»¶
  return {
    type: children,
    props: { fallback }
  };
};

// 4. åˆå§‹åŒ–å¹¶è¿è¡Œæ¨¡æ‹Ÿ
const suspense = new SuspenseSimulator();
// åˆ›å»º fallback å…ƒç´ 
const fallback = document.createElement('div');
fallback.innerHTML = '<div style="color: #666;">åŠ è½½ä¸­... ğŸŒ€</div>';

// æŒ‚è½½ Suspense ç»„ä»¶
suspense.render(
  Suspense({
    fallback: fallback,
    children: DataComponent
  }),
  document.getElementById('root')
);
```
æ ¸å¿ƒé€»è¾‘è§£é‡Šï¼š
- SuspenseSimulator ç±»æ¨¡æ‹Ÿ React æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ï¼Œæ•è·ç»„ä»¶æŠ›å‡ºçš„ Promiseï¼›
- fetchData æ¨¡æ‹Ÿå¼‚æ­¥èµ„æºï¼Œread æ–¹æ³•åœ¨èµ„æºæœªå°±ç»ªæ—¶æŠ›å‡º Promiseï¼Œè§¦å‘ Suspenseï¼›
- ç»„ä»¶æŒ‚è½½åå…ˆæ˜¾ç¤º fallbackï¼ˆåŠ è½½ä¸­ï¼‰ï¼Œ2 ç§’åå¼‚æ­¥èµ„æºå°±ç»ªï¼Œé‡æ–°æ¸²æŸ“å®é™…å†…å®¹ï¼›

### ä¸‰ã€é˜¶æ®µå¤ç›˜è¦ç‚¹ï¼ˆç¬”è®°å‚è€ƒï¼‰
1. å¹¶å‘æ¨¡å¼æ ¸å¿ƒä»·å€¼
- è§£å†³ â€œé•¿ä»»åŠ¡é˜»å¡ä¸»çº¿ç¨‹â€ é—®é¢˜ï¼Œæå‡ç”¨æˆ·äº¤äº’çš„å“åº”æ€§ï¼›
- æ ¸å¿ƒæ˜¯ â€œä¼˜å…ˆçº§è°ƒåº¦â€ï¼Œè€Œé â€œå¤šçº¿ç¨‹â€ï¼ˆReact ä»è¿è¡Œåœ¨å•çº¿ç¨‹ï¼‰ã€‚
2. Suspense æ ¸å¿ƒ
- æœ¬è´¨æ˜¯ â€œæ¸²æŸ“æ—¶çš„å¼‚å¸¸æ•è·ï¼ˆPromiseï¼‰+ å¼‚æ­¥é‡è¯•â€ï¼›
- ä¸ä»…èƒ½ç”¨äºæ•°æ®è¯·æ±‚ï¼Œè¿˜èƒ½ç”¨äºä»£ç åˆ†å‰²ï¼ˆReact.lazy + Suspenseï¼‰ã€‚
3. useDeferredValue/useTransition åŒºåˆ«
- useTransitionï¼šä¸»åŠ¨æ ‡è®° â€œä½ä¼˜å…ˆçº§æ›´æ–°â€ï¼Œæ§åˆ¶æ›´æ–°è¡Œä¸ºï¼›
- useDeferredValueï¼šè¢«åŠ¨åˆ›å»º â€œå»¶è¿Ÿå€¼â€ï¼Œæ§åˆ¶å€¼çš„æ›´æ–°æ—¶æœºï¼›
ä¸¤è€…éƒ½æ˜¯åŸºäºå¹¶å‘æ›´æ–°çš„ä¼˜å…ˆçº§è°ƒåº¦å®ç°ï¼Œæœ€ç»ˆç›®çš„éƒ½æ˜¯ä¸é˜»å¡é«˜ä¼˜å…ˆçº§ä»»åŠ¡ã€‚